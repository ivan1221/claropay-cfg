location /health-check {
    return 200 '200 OK';
    add_header Content-Type text/plain;
}

location /registrar-usuario/ingresar-telefono {
    return 200 '200 OK';
    add_header Content-Type text/plain;
}

location / {

    resolver ${OPENIDC_RESOLVER};

    add_header Last-Modified $date_gmt;
    add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    expires off;
    proxy_no_cache 1;
    if_modified_since off;
    etag off;

    set $target '';
    
    access_by_lua_block {
        local opts = {
            discovery = "${OPENIDC_DISCOVERY}",
            client_id = "${OPENIDC_CIENT_ID}",
            client_secret = "${OPENIDC_CLIENT_SECRET}",
            redirect_uri = "${OPENIDC_REDIRECT_URI}",
            logout_path = "/logout",
            ssl_verify = "no",
            post_logout_redirect_uri = "${OPENIDC_POST_LOGOUT_REDIRECT_URI}",
            redirect_after_logout_uri = "${OPENIDC_REDIRECT_AFTER_LOGOUT_URI}",
            redirect_after_logout_with_id_token_hint = false,
            renew_access_token_on_expiry = true,
            -- access_token_expires_in = 120,
            access_token_expires_in = ${OPENIDC_ACCESS_TOKEN_EXPIRES_IN},
            -- access_token_expires_leeway = 0,
            access_token_expires_leeway = ${OPENIDC_ACCESS_TOKEN_EXPIRES_LEEWAY},
            session_contents = {id_token=true, access_token=true}
          }

        local session_opts = {
            secret = "${OPENIDC_CLIENT_SECRET}"
        }

        -- Only redirect to auth page if client requests text/html, reject with 403 otherwise
        local action = "deny"
        if ngx.var.http_accept then
          for ct in (ngx.var.http_accept .. ","):gmatch("([^,]*),") do
            if string.sub(ct, 0, 9) == "text/html" then
              action = null
              if ngx.var.uri == "/" or ngx.var.uri == "/landing" or string.match(ngx.var.uri, '^/landing/.+$') ~= nil then
               action = "deny" 
              end
              break
            end
          end
        end

        -- call authenticate for OpenID Connect user authentication
        local res, err = require("resty.openidc").authenticate(opts, null, action, session_opts)

        if err then
          if ngx.var.uri ~= "/landing" and string.match(ngx.var.uri, '^/landing/.+$') == nil then
            return ngx.redirect("/landing")
          else
            if ngx.var.uri == "/landing" then
              ngx.var.target = "http://pwa-landing.claropay-ar-desa.svc.cluster.local:8080/"
            else
              if string.match(ngx.var.uri, '^/landing/.+$') ~= nil then
              ngx.var.target = "http://pwa-landing.claropay-ar-desa.svc.cluster.local:8080" .. ngx.var.uri
              end
            end  
          end
        end

        if not err then
          if ngx.var.uri == "/landing" then
            return ngx.redirect("/")
          end 
          -- set data from the ID token as HTTP Request headers
          ngx.req.set_header("X-Auth-Audience", res.id_token.aud)
          ngx.req.set_header("X-Auth-Email", res.id_token.email)
          ngx.req.set_header("X-Auth-ExpiresIn", res.id_token.exp)
          ngx.req.set_header("X-Auth-Groups", res.id_token.groups)
          ngx.req.set_header("X-Auth-Name", res.id_token.name)
          ngx.req.set_header("X-Auth-Subject", res.id_token.sub)
          ngx.req.set_header("X-Auth-Userid", res.id_token.preferred_username)
          ngx.req.set_header("X-Auth-Username", res.id_token.preferred_username)
          ngx.req.set_header("X-Auth-Locale", res.id_token.locale)
          ngx.req.set_header("Authorization", 'Bearer ' .. res.access_token or "")
          --ngx.req.set_header("X-USER", res.id_token.sub)
          --ngx.header["Authorization"] = 'Bearer ' .. res.access_token or ""
        end
    }   

    location ~ \.css {
        add_header Content-Type text/css;
    }

    location ~ \.js {
        add_header Content-Type application/x-javascript;
    }

    location ^~/landing/ {
        #resolver 172.30.0.10;
        proxy_pass $target;
    }

    location ^~/landing {
        #resolver 172.30.0.10;
        proxy_pass $target;
    }

    location /ingresar {
        content_by_lua_block {
          ngx.redirect("/")
        }
    }

    location /api/ {
        proxy_pass https://bff-claropay-ar-desa.apps.osen02.claro.amx/;
    }

    location /webchat/ {
        proxy_pass https://claroidctest.s1gateway.com/api/public/webchat/start/?cpgid=17206/;
    }

    location = /changePass {
      content_by_lua_block {
        ngx.redirect("https://desa-miusuario.claro.com.ar/nuevaClave?c=ClaroPay/")
      }
    }

    location /fraudCheck/ {
        proxy_pass https://cob-fraud-controls-claropay-ar-desa.apps.osen02.claro.amx/;
    }

    location /whatsappLink/ {
        proxy_pass https://desa.claropay.com.ar/;
    }

    location /verifyEmail/ {
        proxy_pass https://desa-login.claro.com.ar/auth/realms/claro/protocol/openid-connect/userinfo;
    }

    location = /changeEmail {
      content_by_lua_block {
        ngx.redirect("https://desa-miusuario.claro.com.ar/confirmarEmailconCodigo?c=ClaroPay&f=c")
      }
    }

    try_files /index.html =404;
}
